#!/usr/bin/env bash
set -euo pipefail

# Run dummy app tests across Appraisals using rake tasks.
# Usage:
#   bin/run-dummy-tests [appraisal|all] [suite]
#   suite: system (default) | generators
# Examples:
#   bin/run-dummy-tests                     # runs system tests for all appraisals
#   bin/run-dummy-tests rails-7.1           # system tests for only rails-7.1
#   bin/run-dummy-tests all generators      # generator tests for all appraisals

REQUESTED=${1:-all}
SUITE=${2:-system}

usage() {
  cat <<USAGE
    Usage: $(basename "$0") [appraisal|all] [suite]
      suite: system (default) | generators
    Examples:
      $(basename "$0")
      $(basename "$0") rails-7.1
      $(basename "$0") all
      $(basename "$0") all generators
USAGE
}

if [[ "$REQUESTED" == "-h" || "$REQUESTED" == "--help" ]]; then
  usage
  exit 0
fi

# Validate suite
case "$SUITE" in
  system|generators)
    ;;
  *)
    echo "Unknown suite: $SUITE" >&2
    usage
    exit 2
    ;;
esac

TASK="test:$SUITE"

# Read Appraisals from `bundle exec appraisal list`. Fail fast if the command isn't available or returns no appraisals.
if ! command -v bundle >/dev/null 2>&1; then
  echo "Error: 'bundle' is not available in PATH. Please install Bundler and try again." >&2
  exit 2
fi

if ! bundle exec appraisal list >/dev/null 2>&1; then
  echo "Error: 'bundle exec appraisal list' failed. Ensure the Appraisal gem is installed and Appraisals file exists." >&2
  exit 2
fi

APPRAISALS=( )
while IFS= read -r line; do
  [[ -z "$line" ]] && continue
  APPRAISALS+=("$line")
done < <(bundle exec appraisal list)

if [[ ${#APPRAISALS[@]} -eq 0 ]]; then
  echo "Error: 'bundle exec appraisal list' returned no appraisals. Aborting." >&2
  exit 2
fi

if [[ "$REQUESTED" != "all" ]]; then
  # validate single appraisal
  FOUND=false
  for a in "${APPRAISALS[@]}"; do
    if [[ "$a" == "$REQUESTED" ]]; then
      APPRAISALS=("$REQUESTED")
      FOUND=true
      break
    fi
  done
  if [[ "$FOUND" == false ]]; then
    echo "Unknown appraisal: $REQUESTED"
    echo "Supported: ${APPRAISALS[*]}"
    exit 2
  fi
fi

echo "Running dummy $SUITE tests for appraisals: ${APPRAISALS[*]}"

for a in "${APPRAISALS[@]}"; do
  echo
  echo "=== Appraisal: $a ==="

  # echo "Preparing dummy DB for $a..."
  # bundle exec appraisal "$a" bash -lc "cd test/dummy && bundle exec rake db:drop db:create db:migrate RAILS_ENV=test"

  echo "Running $SUITE tests for $a via 'rake ${TASK}'..."
  bundle exec appraisal "$a" rake "${TASK}"

  echo "=== Finished $a ==="
done

echo
echo "All requested appraisals completed."
