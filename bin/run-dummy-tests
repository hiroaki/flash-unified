#!/usr/bin/env bash
set -euo pipefail

# Run dummy app system tests across Appraisals.
# Usage:
#   bin/run-dummy-tests [appraisal|all] [test_glob]
# Examples:
#   bin/run-dummy-tests            # runs all appraisals, default glob: test/system/**/*_test.rb
#   bin/run-dummy-tests rails-7.1  # run only rails-7.1
#   bin/run-dummy-tests all "test/system/**/*_test.rb"

REQUESTED=${1:-all}
TEST_GLOB=${2:-test/system/**/*_test.rb}

usage() {
  cat <<USAGE
    Usage: $(basename "$0") [appraisal|all] [test_glob]
    Examples:
      $(basename "$0")
      $(basename "$0") rails-7.1
      $(basename "$0") all "test/system/**/*_test.rb"
USAGE
}

if [[ "$REQUESTED" == "-h" || "$REQUESTED" == "--help" ]]; then
  usage
  exit 0
fi

# Read Appraisals from `bundle exec appraisal list`. Fail fast if the command isn't available or returns no appraisals.
if ! command -v bundle >/dev/null 2>&1; then
  echo "Error: 'bundle' is not available in PATH. Please install Bundler and try again." >&2
  exit 2
fi

if ! bundle exec appraisal list >/dev/null 2>&1; then
  echo "Error: 'bundle exec appraisal list' failed. Ensure the Appraisal gem is installed and Appraisals file exists." >&2
  exit 2
fi

APPRAISALS=( )
while IFS= read -r line; do
  [[ -z "$line" ]] && continue
  APPRAISALS+=("$line")
done < <(bundle exec appraisal list)

if [[ ${#APPRAISALS[@]} -eq 0 ]]; then
  echo "Error: 'bundle exec appraisal list' returned no appraisals. Aborting." >&2
  exit 2
fi

if [[ "$REQUESTED" != "all" ]]; then
  # validate single appraisal
  FOUND=false
  for a in "${APPRAISALS[@]}"; do
    if [[ "$a" == "$REQUESTED" ]]; then
      APPRAISALS=("$REQUESTED")
      FOUND=true
      break
    fi
  done
  if [[ "$FOUND" == false ]]; then
    echo "Unknown appraisal: $REQUESTED"
    echo "Supported: ${APPRAISALS[*]}"
    exit 2
  fi
fi

echo "Running dummy system tests for appraisals: ${APPRAISALS[*]}"

for a in "${APPRAISALS[@]}"; do
  echo
  echo "=== Appraisal: $a ==="

  # echo "Preparing dummy DB for $a..."
  # bundle exec appraisal "$a" bash -lc "cd test/dummy && bundle exec rake db:drop db:create db:migrate RAILS_ENV=test"

  echo "Running tests for $a (glob: $TEST_GLOB)..."
  bundle exec appraisal "$a" rake test TEST="$TEST_GLOB"

  echo "=== Finished $a ==="
done

echo
echo "All requested appraisals completed."
